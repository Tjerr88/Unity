<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Unity 2025</title>
  <style>
    :root{color-scheme:dark light}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial,sans-serif;background:#0b1220;color:#e6eaf2}
    a{color:inherit}
    .app{max-width:1000px;margin:0 auto;padding:20px 16px 56px}
    h1{font-size:clamp(24px,3.6vw,36px);line-height:1.1;margin:4px 0 16px}
    h2{font-size:clamp(18px,2.4vw,22px);opacity:.9;margin:24px 0 8px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:linear-gradient(180deg,#101a30,#0c1527);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 14px 16px}
    .card h3{margin:0 0 10px;font-size:15px;letter-spacing:.2px;opacity:.95}
    .muted{opacity:.72}
    .btn{background:#1a2a4a;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:#2b63ff;border-color:#2b63ff;color:white}
    .btn.danger{background:#842029;border-color:#842029}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.16)}
    .stack{display:grid;gap:10px}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:760px){.grid.cols-2{grid-template-columns:1fr}}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;opacity:.8}
    select, input[type="number"], input[type="text"]{background:#0d1830;border:1px solid rgba(255,255,255,.14);color:#e6eaf2;padding:10px 12px;border-radius:10px;outline:none}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:#2b63ff}
    .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:16px 0}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px;letter-spacing:.2px}
    .badge.red{background:#4a0e14;color:#ffb3bd;border:1px solid #7e1821}
    .badge.green{background:#103f1b;color:#b8f0c2;border:1px solid #1b6e2f}
    .tiny{font-size:12px;opacity:.8}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .session{white-space:pre-wrap;background:#0e182c;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:16px;line-height:1.6}
    .head{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .spacer{flex:1}
    .footer{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,rgba(11,18,32,.0),rgba(11,18,32,.9)),#0b1220;border-top:1px solid rgba(255,255,255,.08);padding:10px 16px;display:flex;gap:10px;align-items:center;justify-content:center}
    .list{display:grid;gap:8px}
    .mutebar{font-size:12px;opacity:.75}
    .kbd{font-family:ui-monospace,monospace;background:#101a30;border:1px solid rgba(255,255,255,.14);padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="app">
  <div class="head">
    <div>
      <h1>Unity 2025</h1>
      <div class="muted">Periodiek circuitprogramma • 8 patronen • 100% client-side</div>
    </div>
    <div class="spacer"></div>
    <button id="btnNewBlock" class="btn primary">Nieuw blok genereren</button>
  </div>

  <div id="settings" class="card" style="margin-top:12px">
    <h3>Blokinstellingen</h3>
    <div class="grid cols-2">
      <div class="field">
        <label>Blokvolume</label>
        <select id="selVolume">
          <option value="180">180</option>
          <option value="240">240</option>
          <option value="300" selected>300</option>
          <option value="400">400</option>
          <option value="500">500</option>
        </select>
      </div>
      <div class="field">
        <label>Seed (optioneel, reproduceerbare volgorde)</label>
        <input id="inpSeed" placeholder="bv. 12345" />
      </div>
      <div class="field">
        <label>Plan Strong overlay</label>
        <div class="row">
          <label class="switch"><input type="checkbox" id="togPS" /> <span>Plan Strong aan</span></label>
          <label class="switch"><input type="checkbox" id="togPSBarbell" /> <span>Barbell op Low-dag</span></label>
        </div>
      </div>
      <div class="field">
        <label>PS-patroon (grind)</label>
        <select id="selPSPattern">
          <option value="">–</option>
          <option>Push</option>
          <option>Squat</option>
          <option>Lunge</option>
          <option>Rotation</option>
        </select>
      </div>
      <div class="field">
        <label>Bodyweight toggle (vervangt Acc3)</label>
        <label class="switch"><input type="checkbox" id="togBW" /> <span>Bodyweight aan</span></label>
      </div>
      <div class="field">
        <label>Advanced exercises toggle (hook)</label>
        <label class="switch"><input type="checkbox" id="togADV" /> <span>Advanced hook aan</span></label>
      </div>
      <div class="field">
        <label>KB variatie (Min=Heavy +1, Max=Light −1)</label>
        <label class="switch"><input type="checkbox" id="togBias" checked /> <span>Variatie aan</span></label>
      </div>
      <div class="field">
        <label>Voortgang</label>
        <div class="row">
          <button id="btnReset" class="btn danger">Reset voortgang</button>
          <span class="muted">Gebruik <span class="kbd">Complete</span> om door sessies te gaan.</span>
        </div>
      </div>
    </div>
  </div>

  <div id="info" class="card" style="margin-top:12px">
    <h3>Blokinfo</h3>
    <div id="kpi" class="kpi"></div>
    <div class="hr"></div>
    <div id="weekOrders" class="list tiny"></div>
    <div class="hr"></div>
    <div class="tiny mutebar">Weekpercentages: Deload 15% • Maintenance 22% • Development 28% • Stress 35%. Sessieverdelingen (bij 300): Deload 6/15/24 • Maintenance 9/15/18/24 • Development 12/18/24/30 • Stress 9/15/21/27/33.</div>
  </div>

  <div id="sessionCard" class="card" style="margin-top:12px">
    <div class="head" style="margin-bottom:8px">
      <h3>Huidige sessie</h3>
      <div class="row">
        <button id="btnPrev" class="btn ghost">◀ Vorige</button>
        <button id="btnComplete" class="btn primary">Complete ▶</button>
      </div>
    </div>
    <div id="sessionText" class="session mono"></div>
  </div>

  <div class="footer">
    <div class="mutebar">Opslag: <span class="kbd">localStorage.unity2025</span> • Hostbaar op GitHub Pages • Offline-klaar</div>
  </div>
</div>

<script>
// =============================
// Unity 2025 — Single-file app
// =============================
(function(){
  const LS_KEY = 'unity2025';
  const VERSION = '2025.10.06';
  const rnd = makeRNG();

  // ---------- Domain Data ----------
  const WEEK_TYPES = ['Deload','Maintenance','Development','Stress'];
  const WEEK_PCT = { Deload:.15, Maintenance:.22, Development:.28, Stress:.35 };
  const BASE_SPLITS = {
    Deload: [6,15,24],
    Maintenance: [9,15,18,24],
    Development: [12,18,24,30],
    Stress: [9,15,21,27,33]
  };

  const PATTERNS = [
    {key:'Push', main:'Military Press', acc:['Floor Press','Half-kneeling Press','Push Press','Top-down Press','Push Jerk'], body:['Push-up','Pike Push-up','Handstand Hold']},
    {key:'Pull', main:'Double Clean', acc:['Bent-over Row (Double)','Renegade Row','Dead Clean → Row','One-arm High Pull'], body:['Inverted Row','Table Row']},
    {key:'Squat', main:'Double Front Squat', acc:['Goblet Squat','Side Lunge / Cossack','Bulgarian Split Squat','Step-up/Pistol','Jump Squat'], body:['Air Squat','Split Squat','Step-up (BW)']},
    {key:'Lunge', main:'Tactical Lunge', acc:['Athletic Lunge (Rev Lunge + Clean/Snatch)','Reverse Lunge','Forward Lunge','Step-back Lunge'], body:['Reverse Lunge (BW)','Split Squat (BW)']},
    {key:'Hinge', main:'Two-arm Swing', acc:['Deadlift','B-stance Deadlift','One-arm Swing','Hand-to-hand Swing','Glute Bridge'], body:['Hip Hinge (BW)','Single-leg RDL (BW)']},
    {key:'Rotation', main:'Turkish Get Up', acc:['Windmill','Bent Press','Half-kneeling Windmill'], body:['Russian Twist (BW)','Supine Get-up Sit-up']},
    {key:'Anti-Rotation', main:'Snatch / Deadstop Swing', acc:['Snatch','Deadstop Swing','Front Rack Hold'], body:['Pallof Press (band)','Front Rack Hold (BW alt)']},
    {key:'Loaded Carry', main:'Suitcase Carry', acc:['Rack Carry','Farmer Carry','Cross-body Carry'], body:['Suitcase Carry (light)']}
  ];

  const BALLISTICS = new Set(['Snatch','One-arm Swing','Two-arm Swing','Hand-to-hand Swing','Clean','Double Clean','High Pull','Push Jerk','Push Press','Deadstop Swing']);

  // UI refs
  const $ = (sel) => document.querySelector(sel);
  const el = {
    btnNewBlock: $('#btnNewBlock'),
    selVolume: $('#selVolume'), inpSeed: $('#inpSeed'),
    togPS: $('#togPS'), selPSPattern: $('#selPSPattern'), togPSBarbell: $('#togPSBarbell'),
    togBW: $('#togBW'), togADV: $('#togADV'), togBias: $('#togBias'),
    btnReset: $('#btnReset'),
    kpi: $('#kpi'), weekOrders: $('#weekOrders'),
    sessionText: $('#sessionText'), btnComplete: $('#btnComplete'), btnPrev: $('#btnPrev'),
  };

  // ---------- State ----------
  let state = loadState() || {};

  // ---------- Helpers ----------
  function makeRNG(){
    let s = xmur3(String(Date.now()))();
    function rand(){ s ^= s << 13; s ^= s >>> 17; s ^= s << 5; return (s>>>0)/4294967296 }
    rand.seed = (t)=>{ s = xmur3(String(t))() };
    return rand;
  }
  function xmur3(str){ for(var i=0,h=1779033703^str.length;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19} return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0} }
  function choice(arr){ return arr[Math.floor(rnd()*arr.length)] }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)) }
  function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'null') }catch(e){ return null } }
  function resetProgress(){ localStorage.removeItem(LS_KEY); state={}; renderInfo(); renderSession(); }

  function roundsAndCap(volume){
    switch(+volume){
      case 180: return {rounds:3, cap:3};
      case 240: return {rounds:3, cap:4};
      case 300: return {rounds:3, cap:5};
      case 400: return {rounds:4, cap:5};
      case 500: return {rounds:5, cap:5};
      default:  return {rounds:3, cap:5};
    }
  }

  // Scale splits to desired block volume and round to multiples of cap (per specs); enforce Delta ≥20% between successive sessions
  function scaleSplits(volume, weekType){
    const {rounds,cap} = roundsAndCap(volume);
    const mul = volume/300;
    const base = BASE_SPLITS[weekType].map(v=>v*mul);
    const unit = cap; // round to multiples of cap per ronde
    let splits = base.map(v=>Math.max(unit, Math.round(v/unit)*unit));
    for(let i=1;i<splits.length;i++){
      const prev = splits[i-1], cur = splits[i];
      const minDelta = Math.round(prev*0.2/unit)*unit;
      if(Math.abs(cur-prev) < Math.max(unit, minDelta)){
        splits[i] = prev + (i%2? 1:-1) * Math.max(unit, minDelta||unit);
        if(splits[i] < unit) splits[i]=unit;
      }
    }
    return splits;
  }

  function lastWeekTypes(){ return (state.lastWeekTypes)||{} }

  function chooseWeekOrder(seed, avoidSame){
    const base = [...WEEK_TYPES];
    shuffle(base);
    if(avoidSame && base[0]===avoidSame){ [base[0],base[1]]=[base[1],base[0]] }
    return base;
  }

  // Build block
  function buildBlock(config){
    if(config.seed) rnd.seed(config.seed);
    const {volume, psOn, psPattern, psBarbell, bodyweight, advanced, kbBias} = config;
    const rc = roundsAndCap(volume);

    const patterns = PATTERNS.map(p=>({key:p.key, main:p.main, acc:[...p.acc], body:[...p.body]}));
    // Anti-Rotation main alternates per block
    const arIndex = patterns.findIndex(p=>p.key==='Anti-Rotation');
    const useSnatch = (state.blockIdx||0)%2===0;
    patterns[arIndex].main = useSnatch ? 'Snatch' : 'Deadstop Swing';

    const lastWT = lastWeekTypes();

    const plan = { weeks:[], meta:{}, rc };
    plan.meta.weekOrders = {};

    for(const p of patterns){
      const avoid = lastWT[p.key];
      const order = chooseWeekOrder(config.seed, avoid);
      plan.meta.weekOrders[p.key] = order;
    }

    const splitsByPatWeek = {};
    for(const p of patterns){
      splitsByPatWeek[p.key] = {};
      for(const wt of WEEK_TYPES){
        splitsByPatWeek[p.key][wt] = scaleSplits(volume, wt);
      }
    }

    const weekLen = Math.max(...Object.values(BASE_SPLITS).map(a=>a.length));

    for(let w=0; w<4; w++){
      const week = { index:w+1, days:[] };
      for(let d=0; d<weekLen; d++){
        const day = { index:d+1, entries:[], emom:[], carry:null, opener:null, weekTypes:{}, kbBiasTags:{}, ps: null };
        for(const p of patterns){
          const wt = plan.meta.weekOrders[p.key][w];
          day.weekTypes[p.key] = wt;
          const splits = splitsByPatWeek[p.key][wt];
          const val = splits[d]||0;
          if(val>0){
            day.entries.push({pattern:p.key, volume:val, main:p.main, acc:[...p.acc], body:[...p.body]});
          }
        }
        shuffle(day.entries);
        day.carry = pickCarry();
        week.days.push(day);
      }
      plan.weeks.push(week);
    }

    // KB bias tags (min=Heavy, max=Light)
    if(kbBias){
      for(const week of plan.weeks){
        const map = {};
        for(const day of week.days){
          for(const e of day.entries){
            map[e.pattern] = map[e.pattern]||[]; map[e.pattern].push(e.volume);
          }
        }
        const minmax = {};
        for(const [k,arr] of Object.entries(map)){
          const min = Math.min(...arr), max = Math.max(...arr);
          minmax[k] = {min,max};
        }
        for(const day of week.days){
          day.kbBiasTags = {};
          for(const e of day.entries){
            const mm = minmax[e.pattern];
            if(!mm){ day.kbBiasTags[e.pattern]='Medium'; continue; }
            if(mm.min===mm.max) day.kbBiasTags[e.pattern]='Medium';
            else if(e.volume===mm.min) day.kbBiasTags[e.pattern]='Heavy';
            else if(e.volume===mm.max) day.kbBiasTags[e.pattern]='Light';
            else day.kbBiasTags[e.pattern]='Medium';
          }
        }
      }
    }

    // Plan Strong overlay
    if(psOn && psPattern){
      for(const week of plan.weeks){
        const order = ['Low','Medium','High'];
        let psDayIdxs = spread3(week.days.length);
        for(let i=0;i<week.days.length;i++){
          const day = week.days[i];
          day.entries = day.entries.filter(e=>e.pattern!==psPattern);
          if(psDayIdxs.includes(i)){
            const level = order[psDayIdxs.indexOf(i)];
            day.ps = { pattern: psPattern, level, barbell: (psBarbell && level==='Low') };
          }
        }
      }
    }

    // Persist last week types
    plan.meta.endsWith = {};
    for(const p of patterns){ plan.meta.endsWith[p.key] = plan.meta.weekOrders[p.key][3]; }

    return plan;
  }

  function spread3(n){
    const a = Math.floor(n*0.1), b = Math.floor(n*0.5), c = Math.floor(n*0.85);
    const set = new Set([Math.min(a,n-1), Math.min(b,n-1), Math.min(c,n-1)]);
    while(set.size<3){ set.add(Math.floor(rnd()*n)) }
    return [...set].sort((x,y)=>x-y);
  }

  function pickCarry(){
    const opts = [
      {name:'Suitcase Carry', fmt:()=>rnd()<.5? `${30+Math.floor(rnd()*60)}s` : `${20+Math.floor(rnd()*40)}m`},
      {name:'Rack Carry', fmt:()=>`${30+Math.floor(rnd()*60)}s`},
      {name:'Farmer Carry', fmt:()=>`${30+Math.floor(rnd()*60)}s`}
    ];
    const c = choice(opts);
    return `${c.fmt()} ${c.name}`;
  }

  function cleanName(n){ return String(n).replace(/\s+/g,' ').trim() }
  function isUnilateral(name){
    const n = cleanName(name).toLowerCase();
    if(n.includes('two-arm')||n.includes('double')||n.includes('front squat')||n.includes('deadlift')||n.includes('jump squat')) return false;
    if(n.includes('swing')&&n.includes('two-arm')) return false;
    if(n.includes('snatch')) return true;
    if(n.includes('press')&&n.includes('double')) return false;
    if(n.includes('row (double)')) return false;
    return true;
  }
  function badge(kind){
    if(kind==='Heavy') return '[Heavy +1]';
    if(kind==='Light') return '[Light −1]';
    return '';
  }
  function decorateName(name, bias){
    const n = cleanName(name);
    // Double Push Press/Jerk altijd overload
    if(n==='Push Press' || n==='Push Jerk' || n==='Double Push Press' || n==='Double Push Jerk'){ bias='Heavy'; }
    if(bias==='Heavy') return `${n}  ${badge('Heavy')}`;
    if(bias==='Light') return `${n}  ${badge('Light')}`;
    return n;
  }
  function formatLine(repText, name){ return `${repText} ${name}`; }

  // EMOM per regels
  function buildEMOM(cands){
    const map = new Map();
    for(const c of cands){ if(['Snatch','One-arm Swing','Two-arm Swing'].includes(c.name)) map.set(c.name,c); }
    if(map.size < 2) return '';
    const order = ['Snatch','One-arm Swing','Two-arm Swing'];
    const parts = [];
    let first = true;
    for(const name of order){
      if(!map.has(name)) continue;
      if(!first) parts.push('Then');
      if(name==='Two-arm Swing'){
        parts.push('EMOM:\n3 minutes of 10 Two-arm Swings (30 totaal = 3 min)');
      }else{
        const ex = name==='Snatch'? 'Snatches' : 'One-arm Swings';
        parts.push(`EMOM:\n6 minutes of 10 ${ex} (alternate side each minute)`);
      }
      first = false;
    }
    return parts.join('\n\n');
  }

  // ---------- Render one day ----------
  function renderDayText(plan, weekIdx, dayIdx, config){
    const week = plan.weeks[weekIdx];
    const day = week.days[dayIdx];
    const {rounds,cap} = plan.rc;

    // 1) Opener: Get Up — hybride regel
    let openerText = '';
    let rotationEntry = day.entries.find(e=>e.pattern==='Rotation');
    let rotationOpenerSets = 0;
    if(rotationEntry){
      const vol = +state.config.volume;
      const isSmall = (vol<=300);
      const sets = isSmall ? 3 : rounds; // 3 bij <=300; 4/5 bij 400/500
      rotationOpenerSets = sets;
      if(sets>0){
        openerText = `${sets} × (1+1) Get Up`;
        const openerUnity = sets * cap; // cap per set
        rotationEntry.volume = Math.max(0, rotationEntry.volume - openerUnity);
      }
    }

    // 2) Circuit: consume volledige pattern-volume via main→acc1→acc2/3; filler tot remaining op is
    const lines = [];
    const emomCandidates = [];

    for(const entry of day.entries){
      if(entry.pattern==='Loaded Carry') continue;
      if(entry.pattern==='Rotation' && entry.volume<=0) continue;

      const acc = [...entry.acc];
      let acc3 = acc[2]||null;
      if(config.bodyweight){ acc3 = (entry.body && entry.body[0]) || acc3; }
      else if(config.advanced){ acc3 = (acc[2]||acc3); }

      const ordered = [entry.main, acc[0]||null, acc[1]||null, acc3||null].filter(Boolean);
      const target = entry.volume;
      const perRoundMax = cap;
      let remaining = target;
      let used = 0;
      let rotPtr = 1;
      const MAX_EX = 3;

      const addExercise = (name, isFiller=false) => {
        let perRound = Math.min(perRoundMax, Math.ceil(remaining/rounds));
        if(BALLISTICS.has(cleanName(name)) && perRoundMax>=10){
          perRound = Math.min(perRoundMax, 10);
        }
        if(isFiller) perRound = Math.max(1, Math.min(perRound, perRoundMax));
        const uni = isUnilateral(name);
        const repText = uni ? `${perRound}+${perRound}` : `${perRound}`;
        const label = isFiller ? `${name} (filler)` : name;
        lines.push(formatLine(repText, decorateName(label, day.kbBiasTags[entry.pattern])));
        if(BALLISTICS.has(cleanName(name)) && perRound===10){
          const t = (cleanName(name)==='Two-arm Swing')? 'bi':'uni';
          emomCandidates.push({name: cleanName(name), type: t});
        }
        remaining -= perRound*rounds;
      };

      // MAIN
      addExercise(ordered[0]); used++;

      // Accessories
      while(remaining>0 && used<MAX_EX){
        const nextName = ordered[rotPtr % ordered.length] || ordered[0];
        rotPtr++;
        addExercise(nextName);
        used++;
      }

      // Filler tot op
      const fillerName = ordered[Math.min(2, ordered.length-1)] || ordered[0];
      let safety = 24;
      while(remaining>0 && safety--){
        addExercise(fillerName, true);
      }
    }

    // Randomize circuit volgorde
    const circuitLines = shuffle(lines.slice());

    // 3) EMOM
    const emomBlock = buildEMOM(emomCandidates);

    // 4) Carry
    const carryText = `[ ${day.carry} ]`;

    // Compose session
    let out = '';
    if(openerText){ out += openerText + "\n\n"; }
    out += '---\n';
    out += `${plan.rc.rounds} rounds of following circuit:\n`;
    out += circuitLines.join('\n') + '\n';
    out += '---\n\n';
    if(emomBlock){ out += emomBlock + '\n---\n\n'; }
    out += `${carryText}`;

    // PS label (optioneel tonen onderaan sessie)
    if(day.ps){
      out += `\n\nPS: ${day.ps.pattern} — ${day.ps.level}${day.ps.barbell?' (Barbell)':''}`;
    }

    return out.trim();
  }

  // ---------- Rendering ----------
  function renderInfo(){
    const s = state;
    const kpi = [];
    if(s.plan){
      kpi.push(`<span class="pill">Volume: <b>${s.config.volume}</b> • Rounds: <b>${s.plan.rc.rounds}</b> • Cap/round: <b>${s.plan.rc.cap}</b></span>`);
      if(s.config.psOn && s.config.psPattern){ kpi.push(`<span class="pill">PS: <b>${s.config.psPattern}</b>${s.config.psBarbell?' (Barbell Low)':''}</span>`); }
      if(s.config.bodyweight) kpi.push(`<span class="pill">Bodyweight Acc3</span>`);
      if(s.config.advanced) kpi.push(`<span class="pill">Advanced hook</span>`);
      if(s.config.kbBias) kpi.push(`<span class="pill">KB variatie actief</span>`);
      kpi.push(`<span class="pill">Blok #${(s.blockIdx||1)}</span>`);
    }
    el.kpi.innerHTML = kpi.join('\n');

    const wo = [];
    if(s.plan){
      for(const [pat,order] of Object.entries(s.plan.meta.weekOrders)){
        wo.push(`<div>${pat}: <b>${order.join(' → ')}</b></div>`);
      }
    }
    el.weekOrders.innerHTML = wo.join('');
  }

  function renderSession(){
    if(!state.plan){ el.sessionText.textContent = 'Nog geen blok. Kies instellingen en klik “Nieuw blok genereren”.'; return; }
    const idx = state.cursor||{w:0,d:0};
    const text = renderDayText(state.plan, idx.w, idx.d, state.config);
    const title = `Week ${idx.w+1}, Dag ${idx.d+1}`;
    el.sessionText.textContent = `${title}\n\n${text}`;
  }

  // ---------- Navigation ----------
  function advance(){
    if(!state.plan) return;
    const weeks = state.plan.weeks;
    let {w,d} = state.cursor||{w:0,d:0};
    d++;
    if(d>=weeks[w].days.length){ w++; d=0; }
    if(w>=weeks.length){
      const ends = state.plan.meta.endsWith;
      state.lastWeekTypes = ends;
      state.blockIdx = (state.blockIdx||1)+1;
      saveState();
      alert('Blok afgerond. Genereer een nieuw blok met jouw voorkeuren. (Start-weektype per patroon zal verschillen van het vorige blok.)');
      return;
    }
    state.cursor = {w,d}; saveState(); renderSession();
  }
  function back(){
    if(!state.plan) return;
    let {w,d} = state.cursor||{w:0,d:0};
    d--; if(d<0){ w--; if(w<0){w=0; d=0;} else { d = state.plan.weeks[w].days.length-1; } }
    state.cursor = {w,d}; saveState(); renderSession();
  }

  // ---------- Block generation ----------
  function newBlock(){
    const cfg = readConfig();
    const plan = buildBlock(cfg);
    state = {
      version: VERSION,
      config: cfg,
      plan,
      cursor: {w:0,d:0},
      lastWeekTypes: state.lastWeekTypes || {},
      blockIdx: (state.blockIdx||1)
    };
    saveState();
    renderInfo();
    renderSession();
  }

  function readConfig(){
    const volume = +el.selVolume.value;
    const seed = (el.inpSeed.value||'').trim();
    const psOn = el.togPS.checked;
    const psPattern = (el.selPSPattern.value||'');
    const psBarbell = el.togPSBarbell.checked;
    const bodyweight = el.togBW.checked;
    const advanced = el.togADV.checked;
    const kbBias = el.togBias.checked;
    return {volume, seed, psOn, psPattern, psBarbell, bodyweight, advanced, kbBias};
  }

  // ---------- Events ----------
  el.btnNewBlock.onclick = newBlock;
  el.btnReset.onclick = ()=>{ if(confirm('Weet je zeker dat je alle voortgang wilt wissen?')) resetProgress(); };
  el.btnComplete.onclick = advance;
  el.btnPrev.onclick = back;

  // ---------- Init ----------
  (function init(){
    if(state && state.plan){ renderInfo(); renderSession(); }
  })();

})();
</script>
</body>
</html>
