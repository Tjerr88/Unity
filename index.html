<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Unity 2025</title>
<!-- Unity 2025 — FULL BUILD (no-custom) f4h_fix3.1 — 2025-10-29
     - Verwijderd: 'Eigen oefeningen' (custom overrides + UI)
     - Behouden: KB-bias (▲/▼ + cap-boost naar 10 bij Light), opener (2+2 bij Light-bias),
                 EMOM-injectie (Swings/Snatch), Plan Strong overlay (M→H→L / H+SH),
                 counters per dag, localStorage, 'on/off'-sanitizers
-->
<style>
  :root{color-scheme:dark}
  *{box-sizing:border-box}
  body{margin:0;background:#0b1220;color:#e6eaf2;font:16px/1.6 system-ui,Arial}
  .app{max-width:980px;margin:0 auto;padding:16px 12px 84px}
  h1{margin:0 0 .6rem;font-size:28px}
  h2{margin:0;font-size:18px}
  .btn{background:#2b63ff;border:0;color:#fff;padding:12px 14px;border-radius:12px;cursor:pointer;font-weight:800;transition:transform .06s ease,filter .15s ease;-webkit-tap-highlight-color:transparent}
  .btn.ghost{background:#1a2a4a}
  .btn.inline{padding:10px 12px;border-radius:10px}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row.stack>*.btn{flex:1}
  .card{background:#101a30;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin:10px 0}
  .session{white-space:pre-wrap;background:#0e182c;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px;line-height:1.7;font-family:ui-monospace,monospace;font-size:clamp(13px,1.9vw,16px)}
  .pill{display:inline-block;background:#182446;border-radius:999px;padding:5px 12px;font-size:12px;margin:3px 3px 0 0}
  details{border:1px solid rgba(255,255,255,.08);border-radius:12px}
  summary{list-style:none;cursor:pointer;padding:12px;font-weight:800;background:#0f1a34;border-radius:12px}
  summary::-webkit-details-marker{display:none}
  details[open]>summary{border-bottom:1px solid rgba(255,255,255,.08);border-bottom-left-radius:0;border-bottom-right-radius:0}
  .panel{padding:12px}
  label{font-size:12px;opacity:.88;display:block;margin:8px 0 4px}
  select,input[type="text"]{width:100%;background:#0d1830;border:1px solid rgba(255,255,255,.18);color:#e6eaf2;padding:10px;border-radius:10px}
  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:760px){.cols-2{grid-template-columns:1fr}.row.stack{display:grid;gap:8px}.btn{padding:14px 16px;border-radius:14px}}
  .muted{opacity:.75;font-size:12px}
  .toast{position:fixed;inset:auto 12px 12px auto;background:#0f1a34;border:1px solid rgba(255,255,255,.15);padding:10px 12px;border-radius:12px;font-size:13px}
  .diag{position:fixed;left:12px;bottom:12px;background:#0f1a34;border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:10px;font:12px/1.4 ui-monospace,monospace;max-width:44ch;max-height:30vh;overflow:auto;display:none}
  .diag b{color:#b8f0c2}
  .badge{display:inline-block;font-weight:800;font-size:12px;padding:3px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.25);margin-left:6px;background:#0f1a34;color:#e6eaf2}
  .counter{display:inline-flex;align-items:center;gap:8px;margin-left:12px;flex:0 0 auto}
  .counter .cbtn{background:#0f1a34;border:1px solid rgba(255,255,255,.2);color:#e6eaf2;border-radius:10px;padding:4px 10px;font-weight:800;cursor:pointer}
  .counter .cval{min-width:64px;text-align:center;font-weight:900}
  .session .line{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:nowrap}
  .session .line .txt{flex:1;min-width:0;white-space:normal}
</style>
</head>
<body>
<div class="app">

  <h1>Unity 2025</h1>

  <div id="tab-plan" class="tab-pane active">

    <div class="row stack" style="margin:8px 0 12px">
      <button id="btnPrevTop" class="btn ghost" aria-label="Vorige sessie">◀ Vorige</button>
      <button id="btnNextTop" class="btn" aria-label="Volgende sessie">Volgende ▶</button>
      <button id="btnCompleteTop" class="btn inline" title="Markeer deze sessie als voltooid">Complete ✔</button>
      <button id="btnNewBlock" class="btn inline" title="Nieuw blok (zet alles opnieuw)">Nieuw blok</button>
    </div>

    <div class="card">
      <h2>Huidige sessie</h2>
      <div id="session" class="session" aria-live="polite">Nog geen blok. Klik op “Nieuw blok”.</div>
    </div>

    <details id="accSettings">
      <summary>Instellingen</summary>
      <div class="panel">
        <div class="grid cols-2">
          <div>
            <label>Blokvolume (Unity)</label>
            <select id="selVol">
              <option>180</option><option>240</option><option selected>300</option><option>400</option><option>500</option>
            </select>
          </div>
          <div>
            <label>Seed (optioneel)</label>
            <input id="inpSeed" placeholder="bv. 12345">
          </div>

          <div>
            <label>Oefeningsset</label>
            <select id="selSet">
              <option value="advanced" selected>Advanced</option>
              <option value="basic">Basis (geen double bells / snatch / bent press / jerk)</option>
            </select>
          </div>

          <div>
            <label>KB-bias (alleen mains; op basis van week-split)</label>
            <select id="selBias">
              <option value="on" selected>Aan (▲/▼)</option>
              <option value="off">Uit</option>
            </select>
          </div>

          <div>
            <label>Plan Strong overlay (1 grind-patroon)</label>
            <select id="selPS">
              <option value="">— Uit —</option>
              <option>Push</option><option>Pull</option><option>Squat</option><option>Hinge</option>
            </select>
          </div>
          <div>
            <label>PS Volume (indien PS aan)</label>
            <select id="selPSVol" disabled>
              <option>180</option><option selected>240</option><option>300</option>
            </select>
          </div>
          <div>
            <label>PS-modus</label>
            <label class="row" style="gap:10px">
              <input type="checkbox" id="chkPSAdvanced" disabled>
              <span>Advanced: High + Super Heavy</span>
            </label>
          </div>

          <div>
            <label>Chaos mode (notities/accordeon per oefening)</label>
            <select id="selChaos">
              <option value="off" selected>Uit</option>
              <option value="on">Aan</option>
            </select>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div id="kpi"></div>
          <div id="orders" class="muted" style="margin-top:6px"></div>
          <div class="muted" style="margin-top:6px">
            Weekpercentages: Deload 15% • Maintenance 22% • Development 28% • Stress 35%.<br>
            Splits per partitie: 3 → [15,35,50]% • 4 → [15,22,28,35]% • 5 → [10,15,20,25,30]%.<br>
            Bias (alleen mains): Deload min%=Heavy ▲, max%=Light ▼ • Maint/Dev min%=Heavy ▲, max%=Light ▼ • Stress min%=Heavy ▲, max%=Light ▼.<br>
            Light-bias main: cap-boost tot 10 per ronde (geen PS).<br>
            Plan Strong: 3×/week <b>M→H→L</b> (Advanced = <b>H+SH</b>); volgorde weken vast: Deload → Development → Maintenance → Stress.<br>
            Anti-Rotation main: default Snatch.
          </div>
        </div>

        <div class="row stack" style="margin-top:8px">
          <button id="btnRebuild" class="btn">Instellingen toepassen</button>
          <button id="btnReset" class="btn ghost">Reset voortgang</button>
          <button id="btnResetCounters" class="btn ghost" title="Wis set-tellers van deze sessie">Reset tellers</button>
        </div>
      </div>
    </details>

  </div> <!-- einde tab-plan -->

</div>

<div id="toast" class="toast" style="display:none" aria-live="polite"></div>
<div id="diag" class="diag"></div>

<script>
(function(){
"use strict";

/* ===== Diagnostics ===== */
const diagEl=document.getElementById('diag');
function diag(msg){diagEl.style.display='block';diagEl.innerHTML='<b>Diagnostics</b><br>'+String(msg).replace(/</g,'&lt;');}
window.addEventListener('error',e=>diag((e.message||'error')+'\n'+(e.filename||'')+':'+(e.lineno||'')));

/* ===== Keys & consts ===== */
const LS_KEY='unity2025_state';
const COUNTERS_KEY='unity2025_counters';

const PATTERNS=['Push','Pull','Squat','Lunge','Hinge','Rotation','Anti-Rotation','Loaded Carry'];
const WEEK_TYPES=['Deload','Maintenance','Development','Stress'];
const WEEK_PCT={Deload:.15,Maintenance:.22,Development:.28,Stress:.35};
const SPLITS={3:[0.15,0.35,0.50],4:[0.15,0.22,0.28,0.35],5:[0.10,0.15,0.20,0.25,0.30]};
const DEFAULT_BALLISTICS=new Set(['Snatch','One-arm Swing','Two-arm Swing','High Pull','Double Clean']);

/* ===== Matrices (geen custom) ===== */
const MATRIX_ADV={
  'Push': { main:'Military Press', acc:['Push Press','Half-kneeling Press','Floor Press'] },
  'Pull': { main:'Double Clean', acc:['Pull-up / Chin-up','Double Bent-over Row','High Pull'] },
  'Squat': { main:'Double Front Squat', acc:['Goblet Squat','Bulgarian Split Squat','Step-up'] },
  'Lunge': { main:'Tactical Lunge', acc:['Double Reverse Lunge','Athletic Lunge','Side Lunge'] },
  'Hinge': { main:'Two-arm Swing', acc:['Single-leg Glute Bridge','Double Deadlift','Double Snatch'] },
  'Rotation': { main:'Turkish Get Up', acc:['Windmill','Half-kneeling Windmill','Bent Press'] },
  'Anti-Rotation': { main:'Snatch', acc:['One-arm Swing','Single-leg Deadlift','Renegade Row'] },
  'Loaded Carry': { main:'Suitcase Carry', acc:['Front Rack Carry','Overhead Carry','Bear Crawl'] }
};
const MATRIX_BASIC={
  'Push': { main:'Military Press', acc:['Half-kneeling Press','Floor Press','Push Press'] },
  'Pull': { main:'One-arm Row', acc:['Gorilla Row','One-arm Clean','High Pull'] },
  'Squat': { main:'Goblet Squat', acc:['Step-up','Split Squat','Bodyweight Squat'] },
  'Lunge': { main:'Reverse Lunge', acc:['Tactical Lunge','Forward Lunge','Side Lunge'] },
  'Hinge': { main:'Two-arm Swing', acc:['KB Deadlift','Single-leg Glute Bridge','Hip Hinge (BW)'] },
  'Rotation': { main:'Turkish Get Up', acc:['Half-kneeling Windmill','Windmill','Tall-kneeling Windmill'] },
  'Anti-Rotation': { main:'Snatch', acc:['One-arm Swing','Single-leg Deadlift','Pallof Press (band)'] },
  'Loaded Carry': { main:'Suitcase Carry', acc:['Front Rack Carry','Farmer Carry','Bear Crawl'] }
};

/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const toast=m=>{const t=$('#toast');t.textContent=m;t.style.display='block';clearTimeout(toast._t);toast._t=setTimeout(()=>t.style.display='none',1600);};
function esc(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
const clean=s=>String(s||'').replace(/\s+/g,' ').trim();
function sanitizeName(n){n=clean(n);if(!n)return'';return (n==='on'||n==='off')?'':n;}
function makeRNG(seed){let h=2166136261>>>0;if(seed){for(let i=0;i<seed.length;i++){h^=seed.charCodeAt(i);h=Math.imul(h,16777619)}}else h=Date.now()>>>0;return()=>{h+=0x6D2B79F5;let t=h;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
let rnd=makeRNG('');
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(rnd()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
const choice=a=>a[Math.floor(rnd()*a.length)];
function roundsCap(vol){switch(+vol){case 180:return{rounds:3,cap:3};case 240:return{rounds:3,cap:4};case 300:return{rounds:3,cap:5};case 400:return{rounds:4,cap:5};case 500:return{rounds:5,cap:5};default:return{rounds:3,cap:5};}}
function isUni(name){const n=clean(name).toLowerCase();return /(one-arm|single-leg|lunge|windmill|bent press|renegade row|pull-up|chin-up)/.test(n)}
function isBallistic(name){return DEFAULT_BALLISTICS.has(clean(name))}
function badge(kind){if(kind==='Heavy')return' <span class="badge" title="Heavy (+1 bell)">▲ +1</span>';if(kind==='Light')return' <span class="badge" title="Light (−1 bell)">▼ −1</span>';return''}
function apportion2(total,weights){const W=weights.reduce((a,b)=>a+b,0);if(W<=0)return weights.map(()=>0);const raw=weights.map(v=>v*total/W);const base=raw.map(x=>Math.floor(x));let rem=total-base.reduce((a,b)=>a+b,0);const ord=raw.map((x,i)=>({i,f:x-Math.floor(x)})).sort((a,b)=>b.f-a.f);for(let k=0;k<ord.length&&rem>0;k++){base[ord[k].i]++;rem--;}return base}

/* ===== Counters ===== */
function countersLoad(){try{return JSON.parse(localStorage.getItem(COUNTERS_KEY)||'{}')}catch{return{}}}
function countersSave(o){try{localStorage.setItem(COUNTERS_KEY,JSON.stringify(o))}catch{}}
let counters=countersLoad();
function dayKey(){if(!state.plan||!state.cursor)return'nokey';const{w,d}=state.cursor;return`${state.blockIdx||0}_${w}_${d}`}
function getCount(k){const dk=dayKey();return (counters[dk]&&counters[dk][k])|0}
function setCount(k,val,max){const dk=dayKey();counters[dk]=counters[dk]||{};counters[dk][k]=Math.max(0,Math.min(max,val|0));countersSave(counters)}
function resetDayCounters(){const dk=dayKey();if(counters[dk]){delete counters[dk];countersSave(counters)}}

/* ===== Effective matrix (zonder custom) ===== */
function effectiveMatrix(cfg){
  return (cfg.set==='basic') ? MATRIX_BASIC : MATRIX_ADV;
}

/* ===== State ===== */
let state=safeLoad()||{};
function safeLoad(){try{return JSON.parse(localStorage.getItem(LS_KEY)||'null')}catch(e){diag('load error: '+e.message);return null}}
function save(){try{localStorage.setItem(LS_KEY,JSON.stringify(state))}catch(e){diag('save error: '+e.message)}}

/* ===== Splits & Bias helpers ===== */
function buildWeekSplitsWithPcts(blockVol,weekType){
  const parts=(weekType==='Deload')?3:(weekType==='Stress'?5:4);
  const basePcts=SPLITS[parts].slice();
  const {rounds}=roundsCap(blockVol);
  const weekTotal=Math.round(blockVol*(WEEK_PCT[weekType]||0));
  let sess=basePcts.map(p=>Math.max(rounds,Math.round((weekTotal*p)/rounds)*rounds));
  let diff=weekTotal-sess.reduce((a,b)=>a+b,0);
  let idx=sess.length-1;
  while(Math.abs(diff)>=rounds){
    if(diff>0){sess[idx]+=rounds;diff-=rounds;}
    else if(sess[idx]-rounds>=rounds){sess[idx]-=rounds;diff+=rounds;}
    else {if(idx>0){idx--;continue;}break;}
  }
  const orderIdx=sess.map((_,i)=>i);shuffle(orderIdx);
  return orderIdx.map(i=>({vol:sess[i],pct:basePcts[i]}));
}
function biasFromPct(weekType,pct){
  const parts=(weekType==='Deload')?3:(weekType==='Stress'?5:4);
  const base=SPLITS[parts];const minPct=Math.min(...base);const maxPct=Math.max(...base);
  const eq=(a,b)=>Math.abs(a-b)<1e-9;
  if(eq(pct,minPct))return'Heavy';
  if(eq(pct,maxPct))return'Light';
  return'Medium';
}
function pickDays(count){const d=[0,1,2,3,4];shuffle(d);return d.slice(0,count).sort((a,b)=>a-b);}

/* ===== Planbouw incl. Plan Strong overlay ===== */
function buildPlan(cfg){
  rnd=makeRNG(cfg.seed||'');
  const matrix=effectiveMatrix(cfg);

  const weekOrders={};
  for(const pat of Object.keys(matrix)){
    const order=['Deload','Maintenance','Development','Stress'];shuffle(order);
    weekOrders[pat]=order;
  }

  const weeks=Array.from({length:4},()=>({days:Array.from({length:5},()=>({entries:[],ps:null}))}));

  for(const [pat,def] of Object.entries(matrix)){
    for(let w=0;w<4;w++){
      const wt=weekOrders[pat][w];
      const items=buildWeekSplitsWithPcts(cfg.volume,wt);
      const dayIdxs=pickDays(items.length);
      for(let i=0;i<items.length;i++){
        const d=dayIdxs[i];const {vol,pct}=items[i];
        weeks[w].days[d].entries.push({
          pattern:pat,main:def.main,acc:def.acc.slice(),
          weekType:wt,volume:vol,pct:pct,bias:biasFromPct(wt,pct)
        });
      }
    }
  }

  // Plan Strong overlay (optioneel)
  if(cfg.psPattern){
    const psPat=cfg.psPattern;
    const psBlock=+cfg.psVolume;
    const fixedOrder=['Deload','Development','Maintenance','Stress']; // vaste volgorde
    for(let w=0;w<4;w++){
      const wt=fixedOrder[w];
      const weekVol=Math.round(psBlock*(WEEK_PCT[wt]||0));
      // verwijder PS-patroon uit gewone entries
      for(let dd=0;dd<5;dd++){
        weeks[w].days[dd].entries=weeks[w].days[dd].entries.filter(en=>en.pattern!==psPat);
      }
      const dayIdxs=pickDays(3);
      let weights=[50,35,15];let labels=['Medium','High','Low'];let shOnHigh=false;
      if(cfg.psAdvanced){weights=[30,55,15];labels=['Medium','High','Low'];shOnHigh=true;}
      const sessVols=apportion2(weekVol,weights);
      const psMainName=(matrix[psPat]&&matrix[psPat].main)?matrix[psPat].main:psPat;
      for(let i=0;i<3;i++){
        const d=dayIdxs[i];
        weeks[w].days[d].ps=weeks[w].days[d].ps||{};
        weeks[w].days[d].ps[psPat]={weekType:wt,reps:sessVols[i],mainName:psMainName,level:labels[i],sh:(labels[i]==='High'&&shOnHigh),mode:cfg.psAdvanced?'advanced':'basic'};
      }
    }
  }

  return {weeks, rc:roundsCap(cfg.volume), weekOrders, set:cfg.set};
}

/* ===== EMOM builder ===== */
function buildEMOM(assigned){
  const wantShown=10;
  const have=new Map();
  for(const a of assigned){
    const nm=clean(a.name);
    if(['Snatch','One-arm Swing','Two-arm Swing'].includes(nm) && a.shownPerRound===wantShown){
      have.set(nm,true);
    }
  }
  if(have.size<2) return null;
  const order=['Snatch','One-arm Swing','Two-arm Swing'];
  const parts=[], used=[];
  for(const nm of order){
    if(!have.has(nm)) continue;
    used.push(nm);
    if(nm==='Two-arm Swing'){
      parts.push(`EMOM:\n3 minutes of 10 Two-arm Swings (30 totaal = 3 min)`);
    }else{
      const label=nm==='Snatch'?'Snatches':'One-arm Swings';
      parts.push(`EMOM:\n6 minutes of 10 ${label} (alternate side each minute)\n\nThen`);
    }
  }
  let text=parts.join('\n\n').replace(/\n\nThen$/,'');
  return {text,_names:used};
}

/* ===== UI Renderers ===== */
function renderInfo(){
  if(!state.plan){$('#kpi').innerHTML='';$('#orders').innerHTML='';return;}
  const rc=state.plan.rc;
  const pills=[
    `<span class="pill">Set: ${state.cfg.set==='basic'?'Basis':'Advanced'}</span>`,
    `<span class="pill">Volume: ${state.cfg.volume}</span>`,
    `<span class="pill">Rounds: ${rc.rounds}</span>`,
    `<span class="pill">Cap/round: ${rc.cap}</span>`,
    `<span class="pill">Blok #${state.blockIdx||1}</span>`,
    `<span class="pill">KB-bias: ${state.cfg.bias==='on'?'Aan (▲/▼)':'Uit'}</span>`,
    state.cfg.psPattern? `<span class="pill">Plan Strong: ${state.cfg.psPattern} • Vol: ${state.cfg.psVolume} • ${state.cfg.psAdvanced?'Advanced (H+SH)':'Basic'}</span>`:''
  ].filter(Boolean).join(' ');
  $('#kpi').innerHTML=pills;
  const rows=Object.entries(state.plan.weekOrders).map(([k,v])=>`${k}: <b>${v.join(' → ')}</b>`).join('<br>');
  $('#orders').innerHTML=rows;
}

/* ===== Render Session ===== */
function mkCounterHTML(exKey, max, current){
  const safeKey = exKey.replace(/&/g,'&amp;').replace(/</g,'&lt;');
  return `
    <span class="counter" data-ex="${safeKey}" data-max="${max}">
      <button class="cbtn" data-dec>−</button>
      <span class="cval">${current}/${max}</span>
      <button class="cbtn" data-inc>+</button>
    </span>`;
}
function renderSession(){
  try{
    const out = document.getElementById('session');
    if(!state.plan){ out.textContent='Nog geen blok. Klik op “Nieuw blok”.'; return; }

    const {w,d} = state.cursor;
    const day = state.plan.weeks[w].days[d];
    const rc = state.plan.rc;

    // Opener: Turkish Get Up (2+2 bij light-bias)
    let openerHTML='';
    const rot = day.entries.find(e=>e.pattern==='Rotation');
    if(rot){
      const setsByBlock = rc.rounds;
      const costPerSet = rc.cap;
      const totalCost = setsByBlock * costPerSet;
      const showTwoTwo = (state.cfg.bias==='on' && (rot.bias||'Medium')==='Light');
      const exKeyOp = `Opener — Turkish Get Up`;
      const cur = getCount(exKeyOp);
      const line = `${setsByBlock} × (${showTwoTwo? '2+2':'1+1'}) Turkish Get Up`;
      openerHTML = `<div class="line"><div class="txt">${line}</div>${mkCounterHTML(exKeyOp, setsByBlock, cur)}</div>`;
      rot.volume = Math.max(0, (rot.volume|0) - totalCost);
    }

    // Circuit
    const assigned=[];
    const entries = shuffle(day.entries.slice().filter(e=> e.pattern!=='Loaded Carry'));
    const lineObjs=[];

    for(const e of entries){
      const mainName = sanitizeName(e.main);
      let order;
      if (e.pattern === 'Rotation') {
        order = [...(e.acc || [])].map(sanitizeName).filter(Boolean);
      } else {
        order = [mainName, ...(e.acc||[]).map(sanitizeName)].filter(Boolean);
      }

      const seen = new Set();
      let remaining = e.volume|0;
      let usedCount=0;

      for(let i=0; i<order.length && remaining>0 && usedCount<3; i++){
        const nm = sanitizeName(order[i]);
        if(!nm) continue;
        if(seen.has(nm)) continue;
        seen.add(nm);

        let perRound = Math.min(rc.cap, Math.ceil(remaining/rc.rounds));
        perRound = Math.max(1, Math.floor(perRound));

        const isMainLine = (nm===mainName);
        const lightBoost = (state.cfg.bias==='on' && e.bias==='Light' && isMainLine && !day.ps);
        if(lightBoost){ perRound = Math.min(10, Math.max(perRound, rc.cap)); }

        const ball = isBallistic(nm);
        const uni = isUni(nm);
        const shown = perRound * (ball?2:1);
        const repText = uni ? `${shown}+${shown}` : `${shown}`;

        let labelHTML = '';
        if(isMainLine && state.cfg.bias==='on' && !day.ps){
          labelHTML = (e.bias==='Heavy') ? badge('Heavy') : (e.bias==='Light') ? badge('Light') : '';
        }

        lineObjs.push({name:nm, repText, htmlLabel:labelHTML, isMain:isMainLine});
        const totalUnity = perRound * rc.rounds;
        assigned.push({name:nm,totalUnity,shownPerRound:shown});
        remaining -= totalUnity; usedCount++;
      }

      // Filler indien rest
      if(remaining > 0 && order.length){
        const fallback = order[Math.min(2, order.length-1)] || order[0];
        let safety=16;
        while(remaining>0 && safety--){
          const nm = sanitizeName(fallback);
          if(!nm) break;
          let perRound = Math.max(1, Math.min(rc.cap, Math.ceil(remaining/rc.rounds)));
          const ball = isBallistic(nm);
          const uni = isUni(nm);
          const shown = perRound * (ball?2:1);
          const repText = uni ? `${shown}+${shown}` : `${shown}`;
          lineObjs.push({name:nm, repText, htmlLabel:'', isMain:false});
          const totalUnity = perRound * rc.rounds;
          assigned.push({name:nm,totalUnity,shownPerRound:shown});
          remaining -= totalUnity;
        }
      }
    }

    // Plan Strong injectie
    if(day.ps){
      const injected=[];
      for(const [pat,info] of Object.entries(day.ps)){
        const T = Math.max(0, info.reps|0);
        const labels = (info.mode==='advanced'||info.sh)?['L','M','H','SH']:['L','M','H'];
        const weights = (labels.length===4)?[45,30,20,5]:[50,35,15];
        const buckets = apportion2(T, weights);
        const rounds = state.plan.rc.rounds;
        const roundsWeights = Array(rounds).fill(1);
        const perRound = buckets.map(v => apportion2(v, roundsWeights));
        const roundLabels=[];
        for (let r=0;r<rounds;r++){
          const parts=[];
          for(let j=0;j<labels.length;j++){
            if (perRound[j][r]>0) parts.push(`${labels[j]}${perRound[j][r]}`);
          }
          roundLabels.push(parts.length?parts.join('/'):'—');
        }
        const detail = roundLabels.map((s,i)=>`R${i+1}:${s}`).join(' • ');
        injected.push({
          name:`PS — ${info.mainName}`,
          repText:`${rounds} rounds`,
          htmlLabel:` — ${info.level || 'Medium'}${info.sh?' (H+SH)':''} — ${detail}`,
          isMain:true
        });
      }
      if(injected.length){ lineObjs.unshift(...injected); }
    }

    // EMOM
    const emom = buildEMOM(assigned);
    let circuitObjs = lineObjs.slice();
    if(emom){
      const drop = new Set(emom._names.map(clean));
      circuitObjs = circuitObjs.filter(o => !drop.has(clean(o.name)));
    }

    // Carry
    const carrySet = (state.plan.set==='basic'?MATRIX_BASIC:MATRIX_ADV)['Loaded Carry'].acc;
    const carryName = choice(carrySet);
    const carryEntry = day.entries.find(e=>e.pattern==='Loaded Carry');
    const carrySecs = carryEntry ? Math.max(30, (carryEntry.volume|0)*5) : 45;
    const carryTxt = `${carrySecs}s ${carryName}`;

    // Compose HTML
    const parts = [];
    parts.push(esc(`Week ${w+1}, Dag ${d+1}`), '<br><br>');
    if(openerHTML){ parts.push(openerHTML, '<br><br>'); }
    parts.push('<hr>');
    parts.push(esc(`${rc.rounds} rounds of following circuit:`), '<br>');

    if(circuitObjs.length){
      const lines = circuitObjs.map(o=>{
        const exKey = `Circuit — ${o.name}`;
        const cur = getCount(exKey);
        const max = rc.rounds;
        return `<div class="line"><div class="txt">${esc(o.repText)} ${esc(o.name)}${o.htmlLabel}</div>${mkCounterHTML(exKey, max, cur)}</div>`;
      }).join('');
      parts.push(lines, '<br>');
    }else{
      parts.push(esc('(Geen patronen actief in het circuit vandaag)'), '<br>');
    }

    parts.push('<hr><br>');
    if(emom){ parts.push(esc(emom.text).replace(/\n/g,'<br>'), '<br><hr><br>'); }
    parts.push(esc(`[ ${carryTxt} ]`));

    out.innerHTML = parts.join('');

    // Bind counters
    document.querySelectorAll('.counter').forEach($c=>{
      const ex = $c.getAttribute('data-ex');
      const max = +$c.getAttribute('data-max');
      const $val=$c.querySelector('.cval');
      const upd=()=>{ $val.textContent = `${getCount(ex)}/${max}`; };
      const inc=$c.querySelector('[data-inc]');
      const dec=$c.querySelector('[data-dec]');
      if(inc) inc.onclick=()=>{ setCount(ex, getCount(ex)+1, max); upd(); };
      if(dec) dec.onclick=()=>{ setCount(ex, getCount(ex)-1, max); upd(); };
    });

  }catch(e){ diag('renderSession error: '+e.message); }
}

/* ===== Blokbesturing & Info ===== */
function firstNonEmpty(plan){
  for(let w=0; w<plan.weeks.length; w++){
    for(let d=0; d<plan.weeks[w].days.length; d++){
      if(plan.weeks[w].days[d].entries.length>0 || plan.weeks[w].days[d].ps){ return {w,d}; }
    }
  }
  return {w:0,d:0};
}
function readCfg(){
  const psPatSel = (document.getElementById('selPS').value||'');
  const psPat = psPatSel ? psPatSel : null;
  const psVol = document.getElementById('selPSVol').value;
  const advEl = document.getElementById('chkPSAdvanced');
  return {
    set: document.getElementById('selSet').value,
    volume: +document.getElementById('selVol').value,
    seed: (document.getElementById('inpSeed').value||'').trim(),
    bias: document.getElementById('selBias').value,
    psPattern: psPat,
    psVolume: psPat ? psVol : null,
    psAdvanced: (advEl && !advEl.disabled) ? advEl.checked : false,
    chaos: document.getElementById('selChaos').value
  };
}
function buildPlanAndState(cfg, keepBlock=false){
  const plan = buildPlan(cfg);
  const blockIdx = keepBlock ? (state.blockIdx||1) : ((state.blockIdx||0)+1);
  const cursor = firstNonEmpty(plan);
  return { blockIdx, cfg, plan, cursor, lastEnds: state.lastEnds || {} };
}
function renderInfoWrap(){
  try{
    if(!state.plan){ document.getElementById('kpi').innerHTML=''; document.getElementById('orders').innerHTML=''; return; }
    const rc = state.plan.rc;
    const kpi = [
      `<span class="pill">Set: ${state.cfg.set==='basic'?'Basis':'Advanced'}</span>`,
      `<span class="pill">Volume: ${state.cfg.volume}</span>`,
      `<span class="pill">Rounds: ${rc.rounds}</span>`,
      `<span class="pill">Cap/round: ${rc.cap}</span>`,
      `<span class="pill">Blok #${state.blockIdx||1}</span>`,
      `<span class="pill">KB-bias: ${state.cfg.bias==='on'?'Aan (▲/▼)':'Uit'}</span>`,
      state.cfg.psPattern? `<span class="pill">Plan Strong: ${state.cfg.psPattern} • Vol: ${state.cfg.psVolume} • ${state.cfg.psAdvanced?'Advanced (H+SH)':'Basic'}</span>`:''
    ].filter(Boolean).join(' ');
    document.getElementById('kpi').innerHTML = kpi;

    const rows = Object.entries(state.plan.weekOrders).map(([k,v])=>`${k}: <b>${v.join(' → ')}</b>`).join('<br>');
    document.getElementById('orders').innerHTML = rows;
  }catch(e){ diag('renderInfo error: '+e.message); }
}
function newBlock(){ try{ const cfg=readCfg(); state = buildPlanAndState(cfg,false); save(); renderInfoWrap(); renderSession(); toast('Blok aangemaakt'); }catch(e){ diag('newBlock error: '+e.message); } }
function rebuildInPlace(){ try{ const cfg=readCfg(); state = buildPlanAndState(cfg,true); resetDayCounters(); save(); renderInfoWrap(); renderSession(); toast('Planner vernieuwd'); }catch(e){ diag('rebuild error: '+e.message); } }
function next(){
  if(!state.plan){ newBlock(); return; }
  let {w,d} = state.cursor;
  d++; if(d>=5){ d=0; w++; }
  if(w>=4){ toast('Blok afgerond'); return; }
  state.cursor={w,d}; save(); renderSession();
}
function prev(){
  if(!state.plan) return;
  let {w,d} = state.cursor;
  d--; if(d<0){ w--; if(w<0){w=0; d=0;} else { d = 4; } }
  state.cursor={w,d}; save(); renderSession();
}
function complete(){ next(); }

/* ===== PS controls enable/disable ===== */
document.getElementById('selPS').addEventListener('change', (e)=>{
  const on = !!(e.target.value);
  document.getElementById('selPSVol').disabled = !on;
  const adv = document.getElementById('chkPSAdvanced'); if(adv) adv.disabled = !on;
});

/* ===== Buttons ===== */
document.getElementById('btnNewBlock').onclick=newBlock;
document.getElementById('btnRebuild').onclick=rebuildInPlace;
document.getElementById('btnReset').onclick=()=>{
  try{
    localStorage.removeItem(LS_KEY);
    state={};
    document.getElementById('session').textContent='Voortgang gewist. Klik “Nieuw blok”.';
    document.getElementById('kpi').innerHTML=''; document.getElementById('orders').innerHTML='';
    toast('Voortgang gereset');
  }catch(e){ diag('reset error: '+e.message); }
};
document.getElementById('btnNextTop').onclick=next;
document.getElementById('btnPrevTop').onclick=prev;
document.getElementById('btnCompleteTop').onclick=complete;
document.getElementById('btnResetCounters').onclick=()=>{ resetDayCounters(); renderSession(); toast('Tellers gereset voor deze sessie'); };

/* ===== Boot ===== */
if(state && state.plan){ renderInfoWrap(); renderSession(); }

})();
</script>
</body>
</html>
