<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Unity 2025</title>
<!-- Unity 2025 — FINAL CONSOLIDATED BUILD
     SPEC_VERSION: 2025-10-06_f1
     Changelog: GetUp=rounds; Rotation overflow=accessories only; Anti-Rotation=Snatch; PS M-H-L (H+SH adv) per-round view; EMOM 10/round; Barbell picks; Mobile tweaks. -->
<style>
  :root{color-scheme:dark}
  body{margin:0;background:#0b1220;color:#e6eaf2;font:16px/1.6 system-ui,Arial}
  .app{max-width:980px;margin:0 auto;padding:18px 14px 108px}
  h1{margin:0 0 .6rem;font-size:28px}
  h2{margin:0;font-size:18px}
  .btn{background:#2b63ff;border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;transition:transform .06s ease,filter .15s ease;-webkit-tap-highlight-color:transparent}
  .btn.ghost{background:#1a2a4a}
  .btn.inline{padding:6px 10px;font-weight:600;border-radius:8px}
  .btn:active{transform:translateY(1px)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .card{background:#101a30;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;margin:10px 0}
  .session{white-space:pre-wrap;background:#0e182c;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:16px;line-height:1.7;font-family:ui-monospace,monospace;font-size:clamp(13px,1.9vw,15px)}
  .pill{display:inline-block;background:#182446;border-radius:999px;padding:4px 10px;font-size:12px;margin:2px}
  details{border:1px solid rgba(255,255,255,.08);border-radius:12px}
  summary{list-style:none;cursor:pointer;padding:12px 12px;font-weight:700;background:#0f1a34;border-radius:12px}
  summary::-webkit-details-marker{display:none}
  details[open]>summary{border-bottom:1px solid rgba(255,255,255,.08);border-bottom-left-radius:0;border-bottom-right-radius:0}
  .panel{padding:12px}
  label{font-size:12px;opacity:.88;display:block;margin:8px 0 4px}
  select,input[type="text"]{width:100%;background:#0d1830;border:1px solid rgba(255,255,255,.18);color:#e6eaf2;padding:8px 10px;border-radius:8px}
  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:760px){.cols-2{grid-template-columns:1fr}}
  .muted{opacity:.75;font-size:12px}
  .kbd{font-family:ui-monospace,monospace;background:#101a30;border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px}
  .toast{position:fixed;inset:auto 16px 16px auto;background:#0f1a34;border:1px solid rgba(255,255,255,.15);padding:10px 12px;border-radius:10px;font-size:13px}
  .diag{position:fixed;left:16px;bottom:16px;background:#0f1a34;border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:10px;font:12px/1.4 ui-monospace,monospace;max-width:44ch;max-height:30vh;overflow:auto;display:none}
  .diag b{color:#b8f0c2}
  .badge{display:inline-block;font-weight:700;font-size:12px;padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.25);margin-left:6px;background:#0f1a34;color:#e6eaf2}
  .ex-acc{border:1px solid rgba(255,255,255,.14);border-radius:10px;margin:8px 0;background:#0c1730}
  .ex-acc summary{background:#0c1730;padding:10px 12px;border-radius:10px;cursor:pointer}
  .ex-acc .ex-body{padding:10px 12px}
  .ex-note{width:100%;background:#0b162c;color:#e6eaf2;border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 10px;font-family:inherit}
  .ex-actions{margin-top:8px;display:flex;gap:8px;align-items:center}
  .tiny{font-size:12px;opacity:.8}
  }
</style>
</head>
<body>
<div class="app">

  <h1>Unity 2025</h1>

  <!-- Desktop/Tablet knoppenrij -->
  <div class="row" style="margin:8px 0 12px">
    <button id="btnPrevTop" class="btn ghost" aria-label="Vorige sessie">◀ Vorige</button>
    <button id="btnNextTop" class="btn" aria-label="Volgende sessie">Volgende ▶</button>
    <button id="btnCompleteTop" class="btn inline" title="Markeer deze sessie als voltooid">Complete ✔</button>
    <button id="btnNewBlock" class="btn inline" title="Nieuw blok (zet alles opnieuw)">Nieuw blok</button>
  </div>

  <div class="card">
    <h2>Huidige sessie</h2>
    <div id="session" class="session" aria-live="polite">Nog geen blok. Klik op “Nieuw blok”.</div>
  </div>

  <details id="accSettings">
    <summary>Instellingen</summary>
    <div class="panel">
      <div class="grid cols-2">
        <div>
          <label>Blokvolume (Unity)</label>
          <select id="selVol">
            <option>180</option><option>240</option><option selected>300</option><option>400</option><option>500</option>
          </select>
        </div>
        <div>
          <label>Seed (optioneel)</label>
          <input id="inpSeed" placeholder="bv. 12345">
        </div>

        <div>
          <label>Oefeningsset</label>
          <select id="selSet">
            <option value="advanced" selected>Advanced</option>
            <option value="basic">Basis (geen double bells / snatch / bent press / jerk)</option>
          </select>
        </div>
        <div>
          <label>KB-bias (alleen mains; op basis van week-split)</label>
          <select id="selBias">
            <option value="on" selected>Aan (▲/▼)</option>
            <option value="off">Uit</option>
          </select>
        </div>

        <div>
          <label>Plan Strong overlay (1 grind-patroon)</label>
          <select id="selPS">
            <option value="">— Uit —</option>
            <option>Push</option><option>Squat</option><option>Lunge</option><option>Rotation</option>
          </select>
        </div>
        <div>
          <label>PS Volume (indien PS aan)</label>
          <select id="selPSVol" disabled>
            <option>180</option><option selected>240</option><option>300</option>
          </select>
        </div>

        <div>
          <label>PS hoofd-lift (grind, KB of Barbell)</label>
          <select id="selPSMain" disabled></select>
          <div class="tiny muted">Ballistics (Clean/Snatch/Swing) niet selecteerbaar.</div>
        </div>

        <div>
          <label>PS-modus</label>
          <label class="row" style="gap:10px">
            <input type="checkbox" id="chkPSAdvanced" disabled>
            <span>Advanced: High + Super Heavy</span>
          </label>
        </div>

        <div>
          <label>Chaos mode (notities/accordeon per oefening)</label>
          <select id="selChaos">
            <option value="off" selected>Uit</option>
            <option value="on">Aan</option>
          </select>
        </div>
        <div></div>

        <!-- Barbell sectie -->
        <div style="grid-column:1/-1;margin-top:4px">
          <div class="card">
            <b>Barbell per patroon (vervangt main op laagste-% sessie; max 3 tegelijk)</b>
            <div class="grid cols-2" style="margin-top:8px">
              <div>
                <label>Push → Barbell lift</label>
                <select id="selBarPush">
                  <option value="">— Uit —</option>
                  <option value="Barbell Shoulder Press">Barbell Shoulder Press</option>
                  <option value="Barbell Incline Bench Press">Barbell Incline Bench Press</option>
                  <option value="Barbell Bench Press">Barbell Bench Press</option>
                </select>
              </div>
              <div>
                <label>Squat → Barbell lift</label>
                <select id="selBarSquat">
                  <option value="">— Uit —</option>
                  <option value="Barbell Back Squat">Barbell Back Squat</option>
                  <option value="Barbell Front Squat">Barbell Front Squat</option>
                  <option value="Barbell Zercher Squat">Barbell Zercher Squat</option>
                </select>
              </div>
              <div>
                <label>Hinge → Barbell lift</label>
                <select id="selBarHinge">
                  <option value="">— Uit —</option>
                  <option value="Barbell Deadlift (Conventional)">Barbell Deadlift (Conventional)</option>
                  <option value="Barbell Deadlift (Sumo)">Barbell Deadlift (Sumo)</option>
                  <option value="Barbell Good Morning">Barbell Good Morning</option>
                </select>
              </div>
              <div class="muted">
                Barbell vervangt alleen de <b>main</b> van het gekozen patroon, en <b>alleen</b> op de sessie met het <b>laagste %</b> die week.
                KB-bias wordt op die sessie genegeerd. PS-dagen van dat patroon worden door PS bepaald.
              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="card" style="margin-top:12px">
        <div id="kpi"></div>
        <div id="orders" class="muted" style="margin-top:6px"></div>
        <div class="muted" style="margin-top:6px">
          Weekpercentages: Deload 15% • Maintenance 22% • Development 28% • Stress 35%.<br>
          Splits per partitie: 3 → [15,35,50]% • 4 → [15,22,28,35]% • 5 → [10,15,20,25,30]%.<br>
          Bias (alleen mains): Deload 15%=Heavy ▲, 50%=Light ▼ • Maint/Dev 15%=Heavy ▲, 35%=Light ▼ • Stress 10%=Heavy ▲, 30%=Light ▼.<br>
          Afronden naar veelvoud van <span class="kbd">#rondes</span> (niet cap). 180/240/300→3, 400→4, 500→5.<br>
          Plan Strong: 3×/week <b>M→H→L</b> (Advanced = <b>H+SH</b>).
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnRebuild" class="btn">Instellingen toepassen</button>
        <button id="btnReset" class="btn ghost">Reset voortgang</button>
      </div>
    </div>
  </details>

</div>

<div id="toast" class="toast" style="display:none" aria-live="polite"></div>
<div id="diag" class="diag"></div>

<script>
(function(){
  const SPEC_VERSION='2025-10-06_f1';

  // ===== Diagnostics =====
  const diagEl = document.getElementById('diag');
  function diag(msg){ diagEl.style.display='block'; diagEl.innerHTML = '<b>Diagnostics</b><br>'+String(msg).replace(/</g,'&lt;'); }
  window.addEventListener('error', e=>diag(e.message+'\n'+(e.filename||'')+':'+(e.lineno||'')));

  // ===== Canon =====
  const LS_KEY='unity2025_state';
  const NOTES_KEY='unity2025_notes';
  const WEEK_TYPES=['Deload','Maintenance','Development','Stress'];
  const WEEK_PCT={Deload:.15,Maintenance:.22,Development:.28,Stress:.35};
  const SPLITS = { 3:[0.15,0.35,0.50], 4:[0.15,0.22,0.28,0.35], 5:[0.10,0.15,0.20,0.25,0.30] };
  const BALLISTICS = new Set(['Snatch','One-arm Swing','Two-arm Swing','High Pull','Double Clean']); // x2 weergave

  // ===== Matrices (Advanced/Basis) =====
  const MATRIX_ADV = {
    'Push': { main:'Military Press', acc:['Push Press','Half-kneeling Press','Floor Press'] },
    'Pull': { main:'Double Clean', acc:['Pull-up / Chin-up','Double Bent-over Row','High Pull'] },
    'Squat': { main:'Double Front Squat', acc:['Goblet Squat','Bulgarian Split Squat','Step-up'] },
    'Lunge': { main:'Tactical Lunge', acc:['Double Reverse Lunge','Athletic Lunge','Side Lunge'] },
    'Hinge': { main:'Two-arm Swing', acc:['Single-leg Glute Bridge','Double Deadlift','Double Snatch'] },
    'Rotation': { main:'Turkish Get Up', acc:['Windmill','Half-kneeling Windmill','Bent Press'] },
    'Anti-Rotation': { main:'Snatch', acc:['One-arm Swing','Single-leg Deadlift','Renegade Row'] },
    'Loaded Carry': { main:'Suitcase Carry', acc:['Front Rack Carry','Overhead Carry','Bear Crawl'] }
  };
  const MATRIX_BASIC = {
    'Push': { main:'Military Press', acc:['Half-kneeling Press','Floor Press','Push Press'] },
    'Pull': { main:'One-arm Row', acc:['Gorilla Row','One-arm Clean','High Pull'] },
    'Squat': { main:'Goblet Squat', acc:['Step-up','Split Squat','Bodyweight Squat'] },
    'Lunge': { main:'Reverse Lunge', acc:['Tactical Lunge','Forward Lunge','Side Lunge'] },
    'Hinge': { main:'Two-arm Swing', acc:['KB Deadlift','Single-leg Glute Bridge','Hip Hinge (BW)'] },
    'Rotation': { main:'Turkish Get Up', acc:['Half-kneeling Windmill','Windmill','Tall-kneeling Windmill'] },
    'Anti-Rotation': { main:'Snatch', acc:['One-arm Swing','Single-leg Deadlift','Pallof Press (band)'] },
    'Loaded Carry': { main:'Suitcase Carry', acc:['Front Rack Carry','Farmer Carry','Bear Crawl'] }
  };

  // PS main opties — uitsluitend grinds
  const PS_MAIN_OPTIONS_MAP = {
    Push: [
      {group:'KB', name:'Military Press'},
      {group:'BB', name:'Barbell Shoulder Press'},
      {group:'BB', name:'Barbell Incline Bench Press'},
      {group:'BB', name:'Barbell Bench Press'}
    ],
    Squat: [
      {group:'KB', name:'Double Front Squat'},
      {group:'BB', name:'Barbell Back Squat'},
      {group:'BB', name:'Barbell Front Squat'},
      {group:'BB', name:'Barbell Zercher Squat'}
    ],
    Lunge: [
      {group:'KB', name:'Tactical Lunge'},
      {group:'KB', name:'Athletic Lunge'},
      {group:'BB', name:'Barbell Split Squat'},
      {group:'BB', name:'Barbell Reverse Lunge'}
    ],
    Rotation: [
      {group:'KB', name:'Turkish Get Up'},
      {group:'KB', name:'Bent Press'},
      {group:'KB', name:'Half-kneeling Windmill'}
    ]
  };
  const PS_ALLOWED_SET = new Set(['Push','Squat','Lunge','Rotation']);

  // ===== Helpers =====
  const $=s=>document.querySelector(s);
  const toast=(m)=>{ const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1600); };
  function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function makeRNG(seedStr){ let h=2166136261>>>0; if(seedStr){ for(let i=0;i<seedStr.length;i++){ h^=seedStr.charCodeAt(i); h=Math.imul(h,16777619); } } else { h=(Date.now()>>>0); } return function(){ h+=0x6D2B79F5; let t=h; t=Math.imul(t^t>>>15, t|1); t^=t+Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; } }
  let rnd = makeRNG('');
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
  const clean = s => String(s).replace(/\s+/g,' ').trim();
  const choice=a=>a[Math.floor(rnd()*a.length)];
  function roundsCap(vol){ switch(+vol){ case 180:return{rounds:3,cap:3}; case 240:return{rounds:3,cap:4}; case 300:return{rounds:3,cap:5}; case 400:return{rounds:4,cap:5}; case 500:return{rounds:5,cap:5}; default:return{rounds:3,cap:5}; } }
  function isUni(name){ const n=clean(name).toLowerCase(); if(n.includes('double')||n.includes('two-arm')||n.includes('front squat')||n.includes('deadlift ')||n.includes('goblet')||n.includes('carry')) return false; if(n.includes('one-arm')||n.includes('single-leg')||n.includes('lunge')||n.includes('windmill')||n.includes('bent press')||n.includes('side swing')||n.includes('renegade row')||n.includes('pull-up')||n.includes('chin-up')||n.includes('military press')||n.includes('push press')||n.includes('snatch')) return true; return false; }
  function badge(kind){ if(kind==='Heavy') return ' <span class="badge" title="Heavy (+1 bell)" aria-label="Heavy (+1 bell)">▲ +1</span>'; if(kind==='Light') return ' <span class="badge" title="Light (−1 bell)" aria-label="Light (−1 bell)">▼ −1</span>'; return ''; }
  function apportion2(total, weights){ const w=weights.slice(); const W=w.reduce((a,b)=>a+b,0); if(W<=0) return Array(w.length).fill(0); const raw=w.map(v=>(v*total)/W); const base=raw.map(x=>Math.floor(x)); let rem= total - base.reduce((a,b)=>a+b,0); const order=raw.map((x,i)=>({i,frac:x-Math.floor(x)})).sort((a,b)=>b.frac-a.frac); for(let k=0;k<order.length && rem>0;k++){ base[order[k].i]+=1; rem--; } return base; }

  // Notes (chaos)
  function loadNotes(){ try{ return JSON.parse(localStorage.getItem(NOTES_KEY)||'{}') }catch(e){ return {} } }
  function saveNotes(obj){ try{ localStorage.setItem(NOTES_KEY, JSON.stringify(obj)) }catch(e){} }
  let notes = loadNotes();
  function getNote(exName){ return notes[exName]||'' }
  function setNote(exName, val){ notes[exName]=val; saveNotes(notes); }

  // ===== State =====
  let state = safeLoad() || {};
  function safeLoad(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'null') }catch(e){ diag('load error: '+e.message); return null } }
  function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)) }catch(e){ diag('save error: '+e.message) } }

  // ===== Splits helpers =====
  function buildWeekSplitsWithPcts(blockVol, weekType){
    const parts = (weekType==='Deload') ? 3 : (weekType==='Stress' ? 5 : 4);
    const basePcts = SPLITS[parts].slice();
    const {rounds} = roundsCap(blockVol);
    const weekTotal = Math.round(blockVol * (WEEK_PCT[weekType] || 0));
    let sess = basePcts.map(p => Math.max(rounds, Math.round((weekTotal * p) / rounds) * rounds));
    let diff = weekTotal - sess.reduce((a,b)=>a+b,0);
    let idx = sess.length - 1;
    while (Math.abs(diff) >= rounds) {
      if (diff > 0) { sess[idx] += rounds; diff -= rounds; }
      else if (sess[idx] - rounds >= rounds) { sess[idx] -= rounds; diff += rounds; }
      else { if (idx > 0) { idx--; continue; } break; }
    }
    const orderIdx = sess.map((_,i)=>i); shuffle(orderIdx);
    return orderIdx.map(i => ({ vol: sess[i], pct: basePcts[i] }));
  }
  function biasFromPct(weekType, pct){
    const parts = (weekType==='Deload') ? 3 : (weekType==='Stress' ? 5 : 4);
    const base = SPLITS[parts];
    const minPct = Math.min(...base);
    const maxPct = Math.max(...base);
    const eq = (a,b)=> Math.abs(a-b) < 1e-9;
    if (eq(pct, minPct)) return 'Heavy';
    if (eq(pct, maxPct)) return 'Light';
    return 'Medium';
  }
  function pickDays(count){ const d=[0,1,2,3,4]; shuffle(d); return d.slice(0,count).sort((a,b)=>a-b); }

  // UI helpers
  function fillPSMainOptions2(pattern){
    const sel = document.getElementById('selPSMain');
    if(!sel) return;
    sel.innerHTML = '';
    if(!pattern || !PS_ALLOWED_SET.has(pattern)) { sel.disabled = true; return; }
    const opts = PS_MAIN_OPTIONS_MAP[pattern] || [];
    let currentGroup = '';
    for(const o of opts){
      if(o.group !== currentGroup){
        currentGroup = o.group;
        const optGroup = document.createElement('option');
        optGroup.disabled = true;
        optGroup.textContent = `— ${currentGroup} —`;
        sel.appendChild(optGroup);
      }
      const op = document.createElement('option');
      op.value = o.name;
      op.textContent = o.name;
      sel.appendChild(op);
    }
    sel.disabled = false;
    const firstReal = Array.from(sel.options).find(opt=>!opt.disabled);
    if(firstReal) sel.value = firstReal.value;
  }

  // ===== Planbouw =====
  function buildPlan(cfg){
    rnd = makeRNG(cfg.seed||'');
    const matrix = (cfg.set==='basic') ? MATRIX_BASIC : MATRIX_ADV;

    // Anti-Rotation altijd Snatch (nooit Deadstop Swing)
    if (matrix['Anti-Rotation']) matrix['Anti-Rotation'].main = 'Snatch';

    // Weekorders per patroon (start != vorige eind)
    const lastEnds = state.lastEnds || {};
    const weekOrders = {};
    for(const pat of Object.keys(matrix)){
      const order=[...WEEK_TYPES]; shuffle(order);
      if(lastEnds[pat] && order[0]===lastEnds[pat]){ [order[0],order[1]]=[order[1],order[0]]; }
      weekOrders[pat]=order;
    }

    const weeks = Array.from({length:4}, ()=>({days:Array.from({length:5},()=>({entries:[],ps:null}))}));

    // UNITY entries vullen (pct+bias)
    for(const [pat,def] of Object.entries(matrix)){
      for(let w=0; w<4; w++){
        const wt = weekOrders[pat][w];
        const items = buildWeekSplitsWithPcts(cfg.volume, wt);
        const dayIdxs = pickDays(items.length);
        for(let i=0;i<items.length;i++){
          const d = dayIdxs[i];
          const {vol, pct} = items[i];
          weeks[w].days[d].entries.push({
            pattern: pat,
            main: def.main,
            acc: def.acc.slice(),
            weekType: wt,
            volume: vol,
            pct: pct,
            bias: biasFromPct(wt, pct)
          });
        }
      }
    }

    // Barbell per week: op laagste-% sessie per gekozen patroon
    const barCfg = {'Push':(cfg.barPush||'').trim(),'Squat':(cfg.barSquat||'').trim(),'Hinge':(cfg.barHinge||'').trim()};
    for(let w=0; w<4; w++){
      for(const [pat,barLift] of Object.entries(barCfg)){
        if(!barLift) continue;
        const pool=[];
        for(let d=0; d<5; d++){
          for(const e of weeks[w].days[d].entries){
            if(e.pattern===pat){ pool.push({e,dayIdx:d}); }
          }
        }
        if(!pool.length) continue;
        pool.sort((a,b)=>a.e.pct-b.e.pct);
        const target = pool[0].e;
        target._barbellMain = barLift;
      }
    }

    // Plan Strong — 3×/week (M→H→L), Advanced = H+SH
    if(cfg.psPattern){
      const psPat   = cfg.psPattern;
      const psBlock = +cfg.psVolume;
      const fixedOrder = ['Deload','Development','Maintenance','Stress'];

      for(let w=0; w<4; w++){
        const wt = fixedOrder[w];
        const weekVol = Math.round(psBlock * (WEEK_PCT[wt] || 0));

        // verwijder PS-patroon uit alle dagen van deze week
        for(let dd=0; dd<5; dd++){
          weeks[w].days[dd].entries = weeks[w].days[dd].entries.filter(en => en.pattern !== psPat);
        }

        // precies 3 PS-dagen
        const dayIdxs = pickDays(3);

        // M,H,L gewichten (Advanced: H+SH)
        let weights = [35,50,15];  // M,H,L
        let labels  = ['Medium','High','Low'];
        let shOnHigh = false;
        if(cfg.psAdvanced){ weights = [30,55,15]; shOnHigh = true; }

        const sessVols = apportion2(weekVol, weights);
        const psMainName = (cfg.psMain && cfg.psPattern) ? cfg.psMain : (MATRIX_ADV[psPat]||MATRIX_BASIC[psPat]).main;

        for(let i=0;i<3;i++){
          const d = dayIdxs[i];
          weeks[w].days[d].ps = weeks[w].days[d].ps || {};
          weeks[w].days[d].ps[psPat] = {
            weekType: wt,
            reps: sessVols[i],
            mainName: psMainName,
            level: labels[i],
            sh: (labels[i]==='High' && shOnHigh),
            mode: cfg.psAdvanced ? 'advanced' : 'basic'
          };
        }
      }
    }

    return {weeks, rc:roundsCap(cfg.volume), weekOrders, set: cfg.set};
  }

  // EMOM (exact 10/ronde)
  function buildEMOM(assigned){
    const wantShown = 10;
    const has = new Map();
    for(const a of assigned){
      const nm=clean(a.name);
      if(['Snatch','One-arm Swing','Two-arm Swing'].includes(nm) && a.shownPerRound === wantShown){
        has.set(nm,true);
      }
    }
    if(has.size < 2) return null;
    const order=['Snatch','One-arm Swing','Two-arm Swing'];
    const parts=[]; const used=[];
    for(const nm of order){
      if(!has.has(nm)) continue;
      used.push(nm);
      if(nm==='Two-arm Swing'){
        parts.push(`EMOM:\n3 minutes of 10 Two-arm Swings (30 totaal = 3 min)`);
      }else{
        const label = nm==='Snatch'?'Snatches':'One-arm Swings';
        parts.push(`EMOM:\n6 minutes of 10 ${label} (alternate side each minute)\n\nThen`);
      }
    }
    let text = parts.join('\n\n').replace(/\n\nThen$/,'');
    return { text, _names: used };
  }

  // ===== Rendering sessie =====
  function renderSession(){
    try{
      const out = $('#session');
      if(!state.plan){ out.textContent='Nog geen blok. Klik op “Nieuw blok”.'; return; }

      const {w,d} = state.cursor;
      const week = state.plan.weeks[w];
      const day = week.days[d];
      const rc = state.plan.rc;
      const chaosMode = state.cfg.chaos==='on';
      const matrix = (state.plan.set==='basic') ? MATRIX_BASIC : MATRIX_ADV;

      // 1) Opener: Get Up — sets = aantal rondes; rest -> accessories
      let opener='';
      const rot = day.entries.find(e=>e.pattern==='Rotation');
      const setsGetUp = rc.rounds; // 3/4/5 afhankelijk van blokvolume
      if(setsGetUp>0){ opener = `${setsGetUp} × (1+1) Turkish Get Up`; }
      if(rot){ rot.volume = Math.max(0, (rot.volume|0) - setsGetUp*10); }

      // 2) Circuit
      const assigned=[];
      const entries = shuffle(day.entries.slice().filter(e=> e.pattern!=='Loaded Carry'));
      const lineObjs=[];

      for(const e of entries){
        let mainName = e._barbellMain ? e._barbellMain : e.main;

        // Rotation: na opener GEEN Get Up meer; enkel accessories
        let order;
        if (e.pattern === 'Rotation') {
          order = [...(e.acc || [])].filter(Boolean);
        } else {
          order = [mainName, ...(e.acc||[])].filter(Boolean);
        }

        const seen = new Set();
        let remaining = e.volume;
        let usedCount=0;

        // Main → Acc’s (max 3 regels per patroon), cap per oefening per ronde, consumeer al het volume
        for(let i=0; i<order.length && remaining>0 && usedCount<3; i++){
          const nm = clean(order[i]);
          if(seen.has(nm)) continue;
          seen.add(nm);

          let perRound = Math.min(rc.cap, Math.ceil(remaining/rc.rounds));
          perRound = Math.max(1, Math.floor(perRound));

          const isBall = BALLISTICS.has(nm);
          const uni = isUni(nm);
          const shown = perRound * (isBall?2:1);
          const repText = uni ? `${shown}+${shown}` : `${shown}`;

          let labelHTML = '';
          const isMainLine = (nm===clean(mainName));
          const barbellActive = !!e._barbellMain;
          if(isMainLine && state.cfg.bias==='on' && !barbellActive){
            labelHTML = (e.bias==='Heavy') ? badge('Heavy') : (e.bias==='Light') ? badge('Light') : '';
          }

          lineObjs.push({name:nm, repText, htmlLabel:labelHTML, isMain:isMainLine});

          const totalUnity = perRound * rc.rounds;
          const shownPerRound = shown;
          assigned.push({name:nm,totalUnity,shownPerRound});
          remaining -= totalUnity;
          usedCount++;
        }

        // Mini-tertiary filler (laatste acc) als er nog rest is
        if(remaining > 0){
          const fillerName = order[Math.min(2, order.length-1)] || order[0];
          let safety=16;
          while(remaining>0 && safety--){
            let perRound = Math.max(1, Math.min(rc.cap, Math.ceil(remaining/rc.rounds)));
            const isBall = BALLISTICS.has(fillerName);
            const uni = isUni(fillerName);
            const shown = perRound * (isBall?2:1);
            const repText = uni ? `${shown}+${shown}` : `${shown}`;
            lineObjs.push({name:fillerName, repText, htmlLabel:'', isMain:false});
            const totalUnity = perRound * rc.rounds;
            assigned.push({name:fillerName,totalUnity,shownPerRound:shown});
            remaining -= totalUnity;
          }
        }
      }

      // 3) Plan Strong — per sessie verdelen over 3 ronden met labels
      if(day.ps){
        const roundsWeights = Array(rc.rounds).fill(1);
        const injected=[];
        for(const [pat,info] of Object.entries(day.ps)){
          if(!PS_ALLOWED_SET.has(pat)) continue;
          const mainPS = info.mainName || matrix[pat].main;
          const T = Math.max(0, info.reps|0);

          let buckets, labels;
          if(info.mode === 'advanced' || info.sh){
            buckets = apportion2(T, [45,30,20,5]);   // L,M,H,SH
            labels  = ['L','M','H','SH'];
          }else{
            buckets = apportion2(T, [50,35,15]);     // L,M,H
            labels  = ['L','M','H'];
          }

const perRound = buckets.map(v => apportion2(v, roundsWeights)); // [bucket][round]
const roundLabels = [];
for (let r = 0; r < rc.rounds; r++) {
  const parts = [];
  // ✅ volgorde: licht → zwaar (L→M→H→SH)
  const PRIO = (info.mode === 'advanced' || info.sh)
    ? ['L', 'M', 'H', 'SH']
    : ['L', 'M', 'H'];
  for (const prio of PRIO) {
    const idx = labels.indexOf(prio);
    if (idx >= 0 && perRound[idx][r] > 0) parts.push(`${prio}${perRound[idx][r]}`);
  }
  roundLabels.push(parts.length ? parts.join('/') : '—');
}
const detail = roundLabels.map((s, i) => `R${i + 1}:${s}`).join(' • ');
injected.push({
  name: `PS — ${mainPS}`,
  repText: `${rc.rounds} rounds`,
  htmlLabel: ` — ${info.level || 'Medium'}${info.sh ? ' (H+SH)' : ''} — ${detail}`,
  isMain: true
});
        }
        if (injected.length) { lineObjs.unshift(...injected); }
      }
      // 4) EMOM
      const emom = buildEMOM(assigned);
      let circuitObjs = lineObjs.slice();
      if(emom){
        const drop = new Set(emom._names.map(clean));
        circuitObjs = circuitObjs.filter(o => !drop.has(clean(o.name)));
      }

      // 5) Loaded Carry
      const carryEntry = day.entries.find(e=>e.pattern==='Loaded Carry');
      const carryName = choice((state.plan.set==='basic'?MATRIX_BASIC:MATRIX_ADV)['Loaded Carry'].acc);
      const carryTxt = carryEntry ? `${Math.max(30, carryEntry.volume*5)}s ${carryName}` : `45s ${carryName}`;

      // 6) Compose
      const parts = [];
      parts.push(esc(`Week ${w+1}, Dag ${d+1}`), '<br><br>');
      if(opener){ parts.push(esc(opener), '<br><br>'); }
      parts.push('<hr>');
      parts.push(esc(`${rc.rounds} rounds of following circuit:`), '<br>');

      if(circuitObjs.length){
        if(chaosMode){
          parts.push('<div>');
          for(const o of circuitObjs){
            const key = clean(o.name);
            const previous = esc(getNote(key));
            const head = `${esc(o.repText)} ${esc(o.name)}${o.htmlLabel}`;
            parts.push(
              `<details class="ex-acc"><summary>${head}</summary>`+
              `<div class="ex-body">`+
              `<div class="tiny">Vorige notitie: ${previous || '—'}</div>`+
              `<textarea class="ex-note" data-ex="${esc(key)}" rows="2" placeholder="Bijv. 24 kg / 2×24 kg / RPE 8"></textarea>`+
              `<div class="ex-actions"><button class="btn inline" data-save="${esc(key)}">Opslaan</button><span class="tiny">Notitie wordt lokaal bewaard.</span></div>`+
              `</div></details>`
            );
          }
          parts.push('</div>');
        }else{
          parts.push(circuitObjs.map(o => `${esc(o.repText)} ${esc(o.name)}${o.htmlLabel}`).join('<br>'), '<br>');
        }
      }else{
        parts.push(esc('(Geen patronen actief in het circuit vandaag)'), '<br>');
      }

      parts.push('<hr><br>');
      if(emom){ parts.push(esc(emom.text).replace(/\n/g,'<br>'), '<br><hr><br>'); }
      parts.push(esc(`[ ${carryTxt} ]`));

      $('#session').innerHTML = parts.join('');

      // Bind chaos notes
      if(chaosMode){
        document.querySelectorAll('button[data-save]').forEach(btn=>{
          btn.onclick = ()=>{
            const ex = btn.getAttribute('data-save');
            const ta = document.querySelector(`textarea[data-ex="${CSS.escape(ex)}"]`);
            if(ta){ setNote(ex, ta.value.trim()); toast('Notitie opgeslagen'); renderSession(); }
          };
        });
      }

    }catch(e){ diag('renderSession error: '+e.message); }
  }

  // ===== Info render =====
  function renderInfo(){
    try{
      if(!state.plan){ $('#kpi').innerHTML=''; $('#orders').innerHTML=''; return; }
      const rc = state.plan.rc;
      const barBits = [];
      if(state.cfg.barPush)  barBits.push(`Push: ${state.cfg.barPush}`);
      if(state.cfg.barSquat) barBits.push(`Squat: ${state.cfg.barSquat}`);
      if(state.cfg.barHinge) barBits.push(`Hinge: ${state.cfg.barHinge}`);

      const kpi = [
        `<span class="pill">Set: ${state.cfg.set==='basic'?'Basis':'Advanced'}</span>`,
        `<span class="pill">Volume: ${state.cfg.volume}</span>`,
        `<span class="pill">Rounds: ${rc.rounds}</span>`,
        `<span class="pill">Cap/round: ${rc.cap}</span>`,
        `<span class="pill">Blok #${state.blockIdx}</span>`,
        `<span class="pill">KB-bias: ${state.cfg.bias==='on'?'Aan (▲/▼)':'Uit'}</span>`,
        barBits.length? `<span class="pill">Barbell: ${barBits.join(' • ')}</span>` : '',
        state.cfg.psPattern? `<span class="pill">Plan Strong: ${state.cfg.psPattern} • Vol: ${state.cfg.psVolume} • ${state.cfg.psAdvanced?'Advanced (H+SH)':'Basic'}</span>`:''
      ].filter(Boolean).join(' ');
      $('#kpi').innerHTML = kpi;

      const rows = Object.entries(state.plan.weekOrders).map(([k,v])=>`${k}: <b>${v.join(' → ')}</b>`).join('<br>');
      $('#orders').innerHTML = rows;
    }catch(e){ diag('renderInfo error: '+e.message); }
  }

  // ===== Blok besturing =====
  function firstNonEmpty(plan){
    for(let w=0; w<plan.weeks.length; w++){
      for(let d=0; d<plan.weeks[w].days.length; d++){
        if(plan.weeks[w].days[d].entries.length>0 || plan.weeks[w].days[d].ps){ return {w,d}; }
      }
    }
    return {w:0,d:0};
  }
  function newBlock(){
    try{
      const cfg = readCfg();
      const plan = buildPlan(cfg);
      const blockIdx = (state.blockIdx||0)+1;
      state = { blockIdx, cfg, plan, cursor: firstNonEmpty(plan), lastEnds: state.lastEnds || {} };
      save(); renderInfo(); renderSession(); toast('Blok aangemaakt');
    }catch(e){ diag('newBlock error: '+e.message); }
  }
  function next(){
    if(!state.plan){ newBlock(); return; }
    let {w,d} = state.cursor;
    const weeks = state.plan.weeks;
    d++; if(d>=weeks[w].days.length){ d=0; w++; }
    if(w>=weeks.length){
      const matrix = (state.cfg.set==='basic')? MATRIX_BASIC : MATRIX_ADV;
      const ends={}; for(const pat of Object.keys(matrix)){ ends[pat] = state.plan.weekOrders[pat][3]; }
      state.lastEnds=ends; save(); toast('Blok afgerond'); return;
    }
    state.cursor={w,d}; save(); renderSession();
  }
  function prev(){
    if(!state.plan) return;
    let {w,d} = state.cursor;
    d--; if(d<0){ w--; if(w<0){w=0; d=0;} else { d = state.plan.weeks[w].days.length-1; } }
    state.cursor={w,d}; save(); renderSession();
  }
  function complete(){ next(); }
  function resetProgress(){
    try{
      localStorage.removeItem(LS_KEY);
      state={};
      $('#session').textContent='Voortgang gewist. Klik “Nieuw blok”.';
      $('#kpi').innerHTML=''; $('#orders').innerHTML='';
      toast('Voortgang gereset');
    }catch(e){ diag('reset error: '+e.message); }
  }

  function readCfg(){
    const psPatSel = ($('#selPS').value||'');
    const psPat = psPatSel ? psPatSel : null;
    const psVol = $('#selPSVol').value;
    return {
      set: $('#selSet').value,
      volume: +$('#selVol').value,
      seed: ($('#inpSeed').value||'').trim(),
      bias: $('#selBias').value,
      psPattern: psPat,
      psVolume: psPat ? psVol : null,
      psMain: (document.getElementById('selPSMain') && !document.getElementById('selPSMain').disabled) ? document.getElementById('selPSMain').value : null,
      psAdvanced: (document.getElementById('chkPSAdvanced') && !document.getElementById('chkPSAdvanced').disabled) ? document.getElementById('chkPSAdvanced').checked : false,
      chaos: $('#selChaos').value,
      barPush:  $('#selBarPush').value || '',
      barSquat: $('#selBarSquat').value || '',
      barHinge: $('#selBarHinge').value || ''
    };
  }

  // ===== UI bindings =====
  $('#btnNewBlock').onclick=newBlock;
  $('#btnRebuild').onclick=newBlock;
  $('#btnReset').onclick=resetProgress;
  $('#btnNextTop').onclick=()=>{ next(); };
  $('#btnPrevTop').onclick=()=>{ prev(); };
  $('#btnCompleteTop').onclick=complete;

  // PS dropdown enable + vullen
  $('#selPS').addEventListener('change', (e)=>{
    const on = !!(e.target.value);
    $('#selPSVol').disabled = !on;
    fillPSMainOptions2(on ? e.target.value : '');
    const selMain = document.getElementById('selPSMain'); if(selMain) selMain.disabled = !on;
    const adv = document.getElementById('chkPSAdvanced'); if(adv) adv.disabled = !on;
  });

  // restore
  if(state && state.plan){ renderInfo(); renderSession(); }
})();
</script>
</body>
</html>
